<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>语音金书阅读器</title>
<style>
body {
    margin:0;
    font-family:system-ui,Arial,sans-serif;
    background:linear-gradient(135deg,#1f1f2e,#0b0b0b);
    color:#fff;
    overflow:hidden;
}
.header {
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:15px 20px;
    background:rgba(0,0,0,0.5);
}
.header h1 {
    font-size:20px;
    margin:0;
    text-align:center;
    flex-grow:1;
}
.button {
    background:linear-gradient(90deg,#2196f3,#21cbf3);
    border:none;
    color:#fff;
    padding:10px 14px;
    border-radius:8px;
    cursor:pointer;
    font-size:16px;
    margin-left:10px;
    transition:0.3s;
}
.button:hover {
    background:linear-gradient(90deg,#1e88e5,#1fb3e5);
    transform:scale(1.05);
}
.page-container {
    height:calc(100vh - 60px);
    overflow:hidden;
    position:relative;
    padding:20px;
}
.page {
    position:absolute;
    top:0;
    left:100%;
    width:100%;
    height:100%;
    overflow-y:auto;
    padding-right:10px;
    transition:left 0.4s;
}
.page.active { left:0; }
.page.prev { left:-100%; }
.sentence { display:block; margin:10px 0; font-size:18px; }
#textContainer {
    display:none;
    max-height:60vh;
    overflow-y:auto;
    margin-top:10px;
    padding:10px;
    background:rgba(255,255,255,0.1);
    border-radius:8px;
}
</style>
</head>
<body>

<div class="header">
  <button class="button" id="backBtn">📚 返回书库</button>
  <h1 id="bookTitle">加载中...</h1>
  <button class="button" id="readBtn">📖 阅读文字</button>
</div>

<div id="textContainer"></div>
<div class="page-container" id="pageContainer"></div>
<audio id="audioPlayer" controls autoplay></audio>

<script>
const urlParams = new URLSearchParams(window.location.search);
const bookId = urlParams.get('book') || 1; // 默认书籍1
const jsonFile = `assets/book${bookId}.json`;

const backBtn = document.getElementById('backBtn');
backBtn.onclick = ()=>{ window.location.href='library.html'; };

const bookTitle = document.getElementById('bookTitle');
const pageContainer = document.getElementById('pageContainer');
const audioPlayer = document.getElementById('audioPlayer');
const readBtn = document.getElementById('readBtn');
const textContainer = document.getElementById('textContainer');

fetch(jsonFile)
.then(res=>res.json())
.then(data=>{
    bookTitle.textContent = data.title;
    audioPlayer.src = data.audio;
    audioPlayer.play();

    // 分页逻辑
    const pageHeight = pageContainer.clientHeight - 40;
    let currentPage = document.createElement('div');
    currentPage.className='page active';
    pageContainer.appendChild(currentPage);

    data.sentences.forEach(sentence=>{
        const span = document.createElement('span');
        span.className='sentence';
        span.textContent = sentence;
        currentPage.appendChild(span);

        if(currentPage.scrollHeight > pageHeight){
            currentPage.removeChild(span);
            let newPage=document.createElement('div');
            newPage.className='page';
            newPage.appendChild(span);
            pageContainer.appendChild(newPage);
            currentPage = newPage;
        }
    });

    let pages = document.querySelectorAll('.page');
    let currentIndex = 0;

    function showPage(index){
        pages.forEach((p,i)=>{
            p.classList.remove('active','prev');
            if(i===index) p.classList.add('active');
            if(i===index-1) p.classList.add('prev');
        });
    }

    // 滑动翻页
    let startX = 0;
    pageContainer.addEventListener('touchstart', e=>{ startX = e.touches[0].clientX; });
    pageContainer.addEventListener('touchend', e=>{
        let endX = e.changedTouches[0].clientX;
        if(endX-startX>50 && currentIndex>0){ currentIndex--; showPage(currentIndex); }
        else if(startX-endX>50 && currentIndex<pages.length-1){ currentIndex++; showPage(currentIndex); }
    });

    // 阅读按钮显示/隐藏文字
    readBtn.onclick = () => {
        if(textContainer.style.display === "none"){
            textContainer.style.display = "block";
            textContainer.innerHTML = data.sentences.map(s=>`<p>${s}</p>`).join("");
        } else {
            textContainer.style.display = "none";
        }
    };
})
.catch(err=>{
    bookTitle.textContent = "加载失败";
    textContainer.innerText = "❌ " + err;
});
</script>

</body>
</html>
